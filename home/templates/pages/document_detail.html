{% extends 'layouts/base.html' %}
{% block title %} {{ document.title }} {% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home:index' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'home:documents_list' %}">Documents</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ document.title }}</li>
                </ol>
            </nav>
        </div>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title">{{ document.title }}</h2>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Document Type:</strong>
                        {% if document.document_type == 'curriculum' %}
                            <span class="badge bg-primary">Curriculum</span>
                        {% elif document.document_type == 'standards' %}
                            <span class="badge bg-success">Standards</span>
                        {% elif document.document_type == 'lesson_plan' %}
                            <span class="badge bg-info">Lesson Plan</span>
                        {% else %}
                            <span class="badge bg-secondary">Other</span>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <strong>File Format:</strong> {{ document.file_type|upper }}
                    </div>
                    
                    <div class="mb-3">
                        <strong>Uploaded:</strong> {{ document.created_at }}
                    </div>
                    
                    <div class="mb-3">
                        <strong>Processed:</strong>
                        {% if document.processed %}
                            <span class="badge bg-success">Yes</span>
                        {% else %}
                            <span class="badge bg-warning">No</span>
                        {% endif %}
                    </div>
                    
                    {% if document.description %}
                    <div class="mb-3">
                        <strong>Description:</strong>
                        <p>{{ document.description }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <strong>Document File:</strong>
                        <a href="{{ document.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                            <i class="fas fa-download"></i> Download
                        </a>
                    </div>
                    
                    {% if not document.processed %}
                    <div class="mb-3">
                        <button id="process-document" class="btn btn-success" data-id="{{ document.id }}">
                            Process Document
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            {% if job %}
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">Processing Status</h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Status:</strong>
                        {% if job.status == 'pending' %}
                            <span class="badge bg-warning">Pending</span>
                        {% elif job.status == 'processing' %}
                            <span class="badge bg-info">Processing</span>
                        {% elif job.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                        {% elif job.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                        {% endif %}
                    </div>
                    
                    {% if job.started_at %}
                    <div class="mb-3">
                        <strong>Started At:</strong> {{ job.started_at }}
                    </div>
                    {% endif %}
                    
                    {% if job.completed_at %}
                    <div class="mb-3">
                        <strong>Completed At:</strong> {{ job.completed_at }}
                    </div>
                    {% endif %}
                    
                    {% if job.error_message %}
                    <div class="mb-3">
                        <strong>Error Message:</strong>
                        <div class="alert alert-danger">
                            {{ job.error_message }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% if standards_metadata %}
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">Standards Metadata</h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>State:</strong> {{ standards_metadata.state }}
                    </div>
                    
                    <div class="mb-3">
                        <strong>Subject:</strong> {{ standards_metadata.subject }}
                    </div>
                    
                    <div class="mb-3">
                        <strong>Grade Level:</strong> {{ standards_metadata.grade_level }}
                    </div>
                    
                    <div class="mb-3">
                        <strong>Year Published:</strong> {{ standards_metadata.year_published }}
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">Standards ({{ standards|length }})</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Identifier</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for standard in standards %}
                                <tr>
                                    <td><strong>{{ standard.identifier }}</strong></td>
                                    <td>{{ standard.description }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center">No standards found in this document.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">Extracted Content</h3>
                </div>
                <div class="card-body">
                    {% if extracted_contents %}
                        <div class="list-group">
                            {% for content in extracted_contents %}
                                <button type="button" class="list-group-item list-group-item-action content-type" 
                                        data-id="{{ document.id }}" data-type="{{ content.content_type }}">
                                    {{ content.content_type }}
                                </button>
                            {% endfor %}
                        </div>
                        
                        <div class="mt-3">
                            <div id="content-preview" class="d-none">
                                <h4 id="content-title"></h4>
                                <pre id="content-json" class="bg-light p-3" style="max-height: 400px; overflow-y: auto;"></pre>
                                
                                <button id="copy-content" class="btn btn-sm btn-outline-primary mt-2">
                                    <i class="fas fa-copy"></i> Copy to Clipboard
                                </button>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted">
                            {% if document.processed %}
                                No content has been extracted from this document.
                            {% else %}
                                The document has not been processed yet.
                            {% endif %}
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Process document button
        const processButton = document.getElementById('process-document');
        if (processButton) {
            processButton.addEventListener('click', function() {
                const documentId = this.getAttribute('data-id');
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                
                fetch(`/documents/${documentId}/process/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.reload();
                    } else {
                        alert('Error processing document: ' + data.message);
                        this.disabled = false;
                        this.textContent = 'Process Document';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error processing document');
                    this.disabled = false;
                    this.textContent = 'Process Document';
                });
            });
        }
        
        // Content type buttons
        const contentTypeButtons = document.querySelectorAll('.content-type');
        const contentPreview = document.getElementById('content-preview');
        const contentTitle = document.getElementById('content-title');
        const contentJson = document.getElementById('content-json');
        const copyButton = document.getElementById('copy-content');
        
        contentTypeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const documentId = this.getAttribute('data-id');
                const contentType = this.getAttribute('data-type');
                
                // Update active button
                contentTypeButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                fetch(`/api/documents/${documentId}/content/${contentType}/`)
                    .then(response => response.json())
                    .then(data => {
                        contentTitle.textContent = contentType;
                        contentJson.textContent = JSON.stringify(data, null, 2);
                        contentPreview.classList.remove('d-none');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error fetching content');
                    });
            });
        });
        
        if (copyButton) {
            copyButton.addEventListener('click', function() {
                const textToCopy = contentJson.textContent;
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        const originalText = this.innerHTML;
                        this.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        setTimeout(() => {
                            this.innerHTML = originalText;
                        }, 2000);
                    })
                    .catch(error => {
                        console.error('Error copying text:', error);
                        alert('Error copying text');
                    });
            });
        }
        
        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}
{% endblock %}